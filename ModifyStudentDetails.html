<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/native-toast@2.0.0/dist/native-toast.css">
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/native-toast@2.0.0/dist/native-toast.min.js"></script>
    <title>Create Classroom</title>
</head>

<body class="bg-gray-100" style="padding: 10px;">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark w-full">
        <div class="container-fluid">
            <button class="btn btn-dark" onclick="window.location.href='DashboardAdmin.html'">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            <a class="navbar-brand mx-auto" href="#">House Of Tutors</a>
        </div>
    </nav>

    <div class="container flex items-center justify-center min-h-screen mt-5">
        <div class="bg-white shadow-lg rounded-lg p-8 w-full max-w-2xl">
            <h1 class="text-3xl font-bold mb-4 text-center">Create Classroom</h1>
            <form id="createClassroomForm" class="space-y-4">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="title">Classroom Title</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-white" id="title" type="text" placeholder="Enter classroom title">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="teacherFullName">Teacher Full Name</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-white" id="teacherFullName" type="text" placeholder="Enter teacher's full name">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="teacherAddress">Teacher Address</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-white" id="teacherAddress" type="text" placeholder="Enter teacher's address">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="teacherTel">Teacher Telephone</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-white" id="teacherTel" type="text" placeholder="Enter teacher's telephone">
                </div>
                <div class="flex items-center justify-between">
                    <button class="btn btn-primary" type="button" id="createClassroomBtn">Create Classroom</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCwol-nlbl1YbdAiU88nYFv67pJg2XOo9U",
            authDomain: "houseoftutors-f398e.firebaseapp.com",
            databaseURL: "https://houseoftutors-f398e-default-rtdb.firebaseio.com/",
            projectId: "houseoftutors-f398e",
            storageBucket: "houseoftutors-f398e.appspot.com",
            messagingSenderId: "1006665226128",
            appId: "1:1006665226128:web:bcf481758d361da3ef8515",
            measurementId: "G-PEM636J9ZD"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        let classroomId;
        window.onload = async function() {
            try {
                const classroomIdRef = ref(database, "NUMBERS/CURRENT_ID_CLASSROOM/NUMBER");
                const snapshot = await get(classroomIdRef);
                if (snapshot.exists()) {
                    classroomId = snapshot.val();
                    classroomId++;
                }
            } catch (error) {
                console.error("Error retrieving classroom ID:", error);
            }
        };

        document.getElementById('createClassroomBtn').addEventListener('click', async function() {
            const title = document.getElementById('title').value.trim();
            const teacherFullName = document.getElementById('teacherFullName').value.trim();
            const teacherAddress = document.getElementById('teacherAddress').value.trim();
            const teacherTel = document.getElementById('teacherTel').value.trim();
            const vrLink = "https://mindtech.daily.co/HouseOfTutors";

            if (!title || !teacherFullName || !teacherAddress || !teacherTel) {
                nativeToast({
                    message: 'All fields must be filled!',
                    position: 'center',
                    rounded: true,
                    timeout: 4000,
                    type: 'error',
                    icon: false,
                    edge: true,
                    closeOnClick: false
                });
                return;
            }

            const classroomData = {
                CLASSROOM_ID: classroomId,
                STORAGE_FOLDER: `${classroomId}_NOTES`,
                TEACHER_ADDRESS: teacherAddress,
                TEACHER_FULL_NAME: teacherFullName,
                TEACHER_TEL: teacherTel,
                TITLE: title,
                VR_LINK: vrLink
            };

            try {
                const newClassroomRef = ref(database, `CLASSROOMS/CLASSROOM_${classroomId}`);
                await set(newClassroomRef, classroomData);
                nativeToast({
                    message: 'Classroom created successfully!',
                    position: 'center',
                    rounded: true,
                    timeout: 4000,
                    type: 'success',
                    icon: false,
                    edge: true,
                    closeOnClick: false
                });

                await set(ref(database, "NUMBERS/CURRENT_ID_CLASSROOM/NUMBER"), classroomId);
                await set(ref(database, `NUMBERS/ID_CLASSROOM_${classroomId}_NOTES/NUMBER`), 1);

                const email = localStorage.getItem('userEmail');
                if (email) {
                    const adminRef = ref(database, "ADMIN");
                    const adminSnapshot = await get(adminRef);
                    if (adminSnapshot.exists()) {
                        const admins = adminSnapshot.val();
                        let adminKey = null;
                        for (const key in admins) {
                            if (admins[key].EMAIL === email) {
                                adminKey = key;
                                break;
                            }
                        }
                        if (adminKey) {
                            const adminData = admins[adminKey];
                            const virtualRooms = adminData.VIRTUAL_ROOMS ? adminData.VIRTUAL_ROOMS.toString().split(',') : [];
                            virtualRooms.push(classroomId.toString());
                            await update(ref(database, `ADMIN/${adminKey}`), { VIRTUAL_ROOMS: virtualRooms.join(',') });

                            setTimeout(() => {
                                location.reload();
                            }, 2000);
                        }
                    }
                }
            } catch (error) {
                console.error("Error creating classroom:", error);
            }
        });
    </script>
</body>
</html>