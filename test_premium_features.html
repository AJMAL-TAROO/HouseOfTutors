<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Premium Features System - House of Tutors</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.22/dist/full.min.css" rel="stylesheet" type="text/css" />
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-purple-800 mb-6">Premium Features System Test</h1>
        
        <!-- Test Controls -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">Test Controls</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Admin Email (for testing)</label>
                    <input type="email" id="testEmail" class="input input-bordered w-full" placeholder="admin@test.com" value="ajtaroo@gmail.com">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Test Admin Key</label>
                    <input type="text" id="testAdminKey" class="input input-bordered w-full" placeholder="ADMIN_1" value="ADMIN_1">
                </div>
            </div>
            
            <button onclick="loadTestAdmin()" class="btn btn-primary mb-4">Load Admin Data</button>
            
            <div id="adminDataDisplay" class="bg-gray-50 p-4 rounded-lg hidden">
                <h3 class="font-semibold mb-2">Current Admin Data:</h3>
                <pre id="adminDataContent" class="text-xs overflow-x-auto"></pre>
            </div>
        </div>

        <!-- DateTime Helper Functions Test -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">DateTime Helper Functions Test</h2>
            
            <div class="space-y-4">
                <div>
                    <h3 class="font-semibold mb-2">1. Date to Custom Format (DDMMYYHHmm)</h3>
                    <button onclick="testDateToCustomFormat()" class="btn btn-sm btn-secondary">Test Now</button>
                    <div id="dateToCustomResult" class="mt-2 p-3 bg-gray-50 rounded hidden"></div>
                </div>
                
                <div>
                    <h3 class="font-semibold mb-2">2. Custom Format to Date</h3>
                    <input type="text" id="customFormatInput" class="input input-bordered input-sm" placeholder="0612252003" value="0612252003">
                    <button onclick="testCustomFormatToDate()" class="btn btn-sm btn-secondary">Test</button>
                    <div id="customToDateResult" class="mt-2 p-3 bg-gray-50 rounded hidden"></div>
                </div>
                
                <div>
                    <h3 class="font-semibold mb-2">3. Add 30 Days</h3>
                    <button onclick="testAdd30Days()" class="btn btn-sm btn-secondary">Test Now</button>
                    <div id="add30DaysResult" class="mt-2 p-3 bg-gray-50 rounded hidden"></div>
                </div>
                
                <div>
                    <h3 class="font-semibold mb-2">4. Check if Lock Expired</h3>
                    <input type="text" id="lockExpiredInput" class="input input-bordered input-sm" placeholder="0501262003" value="0501262003">
                    <button onclick="testIsLockExpired()" class="btn btn-sm btn-secondary">Test</button>
                    <div id="lockExpiredResult" class="mt-2 p-3 bg-gray-50 rounded hidden"></div>
                </div>
            </div>
        </div>

        <!-- Premium Features Flow Test -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">Premium Features Flow Test</h2>
            
            <div class="alert alert-info mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <span>These tests simulate the premium features flow without Firebase. Use the actual dashboard to test with Firebase.</span>
            </div>
            
            <div class="space-y-4">
                <div>
                    <h3 class="font-semibold mb-2">Scenario 1: Upgrade to Premium</h3>
                    <button onclick="simulateUpgrade()" class="btn btn-sm btn-success">Simulate Upgrade</button>
                    <div id="upgradeResult" class="mt-2 p-3 bg-gray-50 rounded hidden"></div>
                </div>
                
                <div>
                    <h3 class="font-semibold mb-2">Scenario 2: Request Downgrade (Locked)</h3>
                    <button onclick="simulateDowngradeLocked()" class="btn btn-sm btn-warning">Simulate Downgrade (Locked)</button>
                    <div id="downgradeLockedResult" class="mt-2 p-3 bg-gray-50 rounded hidden"></div>
                </div>
                
                <div>
                    <h3 class="font-semibold mb-2">Scenario 3: Request Downgrade (Lock Expired)</h3>
                    <button onclick="simulateDowngradeUnlocked()" class="btn btn-sm btn-warning">Simulate Downgrade (Unlocked)</button>
                    <div id="downgradeUnlockedResult" class="mt-2 p-3 bg-gray-50 rounded hidden"></div>
                </div>
                
                <div>
                    <h3 class="font-semibold mb-2">Scenario 4: Cancel Pending Downgrade</h3>
                    <button onclick="simulateCancelDowngrade()" class="btn btn-sm btn-error">Simulate Cancel</button>
                    <div id="cancelDowngradeResult" class="mt-2 p-3 bg-gray-50 rounded hidden"></div>
                </div>
                
                <div>
                    <h3 class="font-semibold mb-2">Scenario 5: Auto-Downgrade on Load</h3>
                    <button onclick="simulateAutoDowngrade()" class="btn btn-sm btn-info">Simulate Auto-Downgrade</button>
                    <div id="autoDowngradeResult" class="mt-2 p-3 bg-gray-50 rounded hidden"></div>
                </div>
            </div>
        </div>

        <!-- Test Results Summary -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4">Test Instructions</h2>
            <div class="prose">
                <h3>Manual Testing Steps:</h3>
                <ol class="list-decimal list-inside space-y-2">
                    <li>Login to the admin dashboard (DashboardAdmin.html)</li>
                    <li>Click on the "Dashboard Details" icon in the navbar (chart icon)</li>
                    <li>Scroll to the "Premium Plan" section</li>
                    <li>Test the upgrade flow:
                        <ul class="list-disc list-inside ml-4">
                            <li>Click "Upgrade to Premium"</li>
                            <li>Verify warning message shows Rs100/student/month and 30-day lock</li>
                            <li>Confirm upgrade</li>
                            <li>Verify Firebase fields updated correctly</li>
                        </ul>
                    </li>
                    <li>Test the downgrade flow (while locked):
                        <ul class="list-disc list-inside ml-4">
                            <li>Click "Request Downgrade to Basic"</li>
                            <li>Verify message shows lock expiry date</li>
                            <li>Schedule downgrade</li>
                            <li>Verify PENDING_DOWNGRADE set to true</li>
                        </ul>
                    </li>
                    <li>Test cancel downgrade:
                        <ul class="list-disc list-inside ml-4">
                            <li>Click "Cancel Downgrade Request"</li>
                            <li>Confirm cancellation</li>
                            <li>Verify PENDING_DOWNGRADE set to false</li>
                        </ul>
                    </li>
                    <li>Test auto-downgrade:
                        <ul class="list-disc list-inside ml-4">
                            <li>Manually set UNLOCK_FEATURES_LOCKED_UNTIL to a past date in Firebase</li>
                            <li>Set PENDING_DOWNGRADE to true</li>
                            <li>Reload the dashboard</li>
                            <li>Verify auto-downgrade occurs and page reloads</li>
                        </ul>
                    </li>
                </ol>
                
                <h3 class="mt-4">Expected Firebase Structure:</h3>
                <pre class="bg-gray-100 p-4 rounded text-xs overflow-x-auto">
ADMIN
  ADMIN_1
    EMAIL: "admin@example.com"
    UNLOCK_FEATURES: true/false
    FEES_PER_STUDENT: 50 or 100
    UNLOCK_FEATURES_ACTIVATED_ON: "0612252003" (DDMMYYHHmm)
    UNLOCK_FEATURES_LOCKED_UNTIL: "0501262003" (DDMMYYHHmm)
    PENDING_DOWNGRADE: true/false
    ... other fields ...
                </pre>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCwol-nlbl1YbdAiU88nYFv67pJg2XOo9U",
            authDomain: "houseoftutors-f398e.firebaseapp.com",
            databaseURL: "https://houseoftutors-f398e-default-rtdb.firebaseio.com/",
            projectId: "houseoftutors-f398e",
            storageBucket: "houseoftutors-f398e.firebasestorage.app",
            messagingSenderId: "1006665226128",
            appId: "1:1006665226128:web:bcf481758d361da3ef8515",
            measurementId: "G-PEM636J9ZD"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // DateTime helper functions (copied from DashboardAdmin.html)
        function dateToCustomFormat(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = String(date.getFullYear()).slice(-2);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return day + month + year + hours + minutes;
        }

        function customFormatToDate(str) {
            if (!str || str.length !== 10) return null;
            const day = parseInt(str.substring(0, 2), 10);
            const month = parseInt(str.substring(2, 4), 10) - 1;
            const year = 2000 + parseInt(str.substring(4, 6), 10);
            const hours = parseInt(str.substring(6, 8), 10);
            const minutes = parseInt(str.substring(8, 10), 10);
            return new Date(year, month, day, hours, minutes);
        }

        function add30Days(date) {
            const newDate = new Date(date);
            newDate.setDate(newDate.getDate() + 30);
            return newDate;
        }

        function isLockExpired(lockedUntilStr) {
            if (!lockedUntilStr) return true;
            const lockedUntilDate = customFormatToDate(lockedUntilStr);
            if (!lockedUntilDate) return true;
            return new Date() >= lockedUntilDate;
        }

        function formatDateForDisplay(dateStr) {
            const date = customFormatToDate(dateStr);
            if (!date) return 'N/A';
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = String(date.getFullYear()).slice(-2);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}/${month}/${year} at ${hours}:${minutes}`;
        }

        // Make functions global
        window.dateToCustomFormat = dateToCustomFormat;
        window.customFormatToDate = customFormatToDate;
        window.add30Days = add30Days;
        window.isLockExpired = isLockExpired;
        window.formatDateForDisplay = formatDateForDisplay;
        window.database = database;
        window.ref = ref;
        window.get = get;
        window.update = update;

        // Load admin data for testing
        window.loadTestAdmin = async function() {
            const email = document.getElementById('testEmail').value;
            const adminKey = document.getElementById('testAdminKey').value;
            
            try {
                const adminRef = ref(database, `ADMIN/${adminKey}`);
                const snapshot = await get(adminRef);
                
                if (snapshot.exists()) {
                    const adminData = snapshot.val();
                    document.getElementById('adminDataDisplay').classList.remove('hidden');
                    document.getElementById('adminDataContent').textContent = JSON.stringify(adminData, null, 2);
                } else {
                    alert('Admin not found!');
                }
            } catch (error) {
                console.error('Error loading admin:', error);
                alert('Error loading admin: ' + error.message);
            }
        };

        // Test DateTime functions
        window.testDateToCustomFormat = function() {
            const now = new Date();
            const formatted = dateToCustomFormat(now);
            const resultDiv = document.getElementById('dateToCustomResult');
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = `
                <strong>Input:</strong> ${now.toString()}<br>
                <strong>Output:</strong> ${formatted}<br>
                <strong>Expected Format:</strong> DDMMYYHHmm
            `;
        };

        window.testCustomFormatToDate = function() {
            const input = document.getElementById('customFormatInput').value;
            const date = customFormatToDate(input);
            const resultDiv = document.getElementById('customToDateResult');
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = `
                <strong>Input:</strong> ${input}<br>
                <strong>Output:</strong> ${date ? date.toString() : 'Invalid format'}<br>
                <strong>Formatted:</strong> ${date ? formatDateForDisplay(input) : 'N/A'}
            `;
        };

        window.testAdd30Days = function() {
            const now = new Date();
            const after30 = add30Days(now);
            const resultDiv = document.getElementById('add30DaysResult');
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = `
                <strong>Current Date:</strong> ${now.toString()}<br>
                <strong>After 30 Days:</strong> ${after30.toString()}<br>
                <strong>Custom Format:</strong> ${dateToCustomFormat(after30)}
            `;
        };

        window.testIsLockExpired = function() {
            const input = document.getElementById('lockExpiredInput').value;
            const expired = isLockExpired(input);
            const lockedDate = customFormatToDate(input);
            const resultDiv = document.getElementById('lockExpiredResult');
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = `
                <strong>Lock Until:</strong> ${input}<br>
                <strong>Lock Date:</strong> ${lockedDate ? lockedDate.toString() : 'Invalid'}<br>
                <strong>Current Date:</strong> ${new Date().toString()}<br>
                <strong>Is Expired:</strong> <span class="${expired ? 'text-green-600' : 'text-red-600'} font-bold">${expired ? 'YES' : 'NO'}</span>
            `;
        };

        // Simulate premium features flows
        window.simulateUpgrade = function() {
            const now = new Date();
            const activatedOn = dateToCustomFormat(now);
            const lockedUntil = dateToCustomFormat(add30Days(now));
            
            const resultDiv = document.getElementById('upgradeResult');
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = `
                <strong>Upgrade Simulation:</strong><br>
                <span class="text-green-600">✓ UNLOCK_FEATURES set to true</span><br>
                <span class="text-green-600">✓ FEES_PER_STUDENT set to 100</span><br>
                <span class="text-green-600">✓ UNLOCK_FEATURES_ACTIVATED_ON: ${activatedOn} (${formatDateForDisplay(activatedOn)})</span><br>
                <span class="text-green-600">✓ UNLOCK_FEATURES_LOCKED_UNTIL: ${lockedUntil} (${formatDateForDisplay(lockedUntil)})</span><br>
                <span class="text-green-600">✓ PENDING_DOWNGRADE set to false</span>
            `;
        };

        window.simulateDowngradeLocked = function() {
            const now = new Date();
            const lockedUntil = dateToCustomFormat(add30Days(now));
            
            const resultDiv = document.getElementById('downgradeLockedResult');
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = `
                <strong>Downgrade Request Simulation (Locked):</strong><br>
                <span class="text-yellow-600">⚠ Still locked until ${formatDateForDisplay(lockedUntil)}</span><br>
                <span class="text-blue-600">→ User can schedule downgrade</span><br>
                <span class="text-green-600">✓ PENDING_DOWNGRADE set to true</span><br>
                <span class="text-gray-600">• Downgrade will occur automatically on ${formatDateForDisplay(lockedUntil)}</span>
            `;
        };

        window.simulateDowngradeUnlocked = function() {
            const pastDate = new Date();
            pastDate.setDate(pastDate.getDate() - 5); // 5 days ago
            const lockedUntil = dateToCustomFormat(pastDate);
            
            const resultDiv = document.getElementById('downgradeUnlockedResult');
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = `
                <strong>Downgrade Request Simulation (Unlocked):</strong><br>
                <span class="text-green-600">✓ Lock period expired (was ${formatDateForDisplay(lockedUntil)})</span><br>
                <span class="text-green-600">✓ Immediate downgrade performed</span><br>
                <span class="text-green-600">✓ UNLOCK_FEATURES set to false</span><br>
                <span class="text-green-600">✓ FEES_PER_STUDENT set to 50</span><br>
                <span class="text-green-600">✓ PENDING_DOWNGRADE set to false</span>
            `;
        };

        window.simulateCancelDowngrade = function() {
            const resultDiv = document.getElementById('cancelDowngradeResult');
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = `
                <strong>Cancel Downgrade Simulation:</strong><br>
                <span class="text-green-600">✓ PENDING_DOWNGRADE set to false</span><br>
                <span class="text-blue-600">→ User remains on premium plan</span><br>
                <span class="text-gray-600">• User can still request downgrade later</span>
            `;
        };

        window.simulateAutoDowngrade = function() {
            const pastDate = new Date();
            pastDate.setDate(pastDate.getDate() - 1); // 1 day ago
            const lockedUntil = dateToCustomFormat(pastDate);
            
            const resultDiv = document.getElementById('autoDowngradeResult');
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = `
                <strong>Auto-Downgrade Simulation (on dashboard load):</strong><br>
                <span class="text-blue-600">→ Check: UNLOCK_FEATURES = true</span><br>
                <span class="text-blue-600">→ Check: PENDING_DOWNGRADE = true</span><br>
                <span class="text-green-600">✓ Lock expired (${formatDateForDisplay(lockedUntil)})</span><br>
                <span class="text-green-600">✓ Auto-downgrade triggered</span><br>
                <span class="text-green-600">✓ UNLOCK_FEATURES set to false</span><br>
                <span class="text-green-600">✓ FEES_PER_STUDENT set to 50</span><br>
                <span class="text-green-600">✓ PENDING_DOWNGRADE set to false</span><br>
                <span class="text-orange-600">↻ Page reload triggered</span>
            `;
        };
    </script>
</body>
</html>
