<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO Meta Tags -->
    <title>Admin Dashboard - House of Tutors | Manage Your Classes</title>
    <meta name="description" content="Manage classrooms, students, and teaching resources at House of Tutors admin dashboard.">
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://www.housesoftutors.com/DashboardAdmin.html">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.22/dist/full.min.css" rel="stylesheet" type="text/css" />
    <style>
        .card:hover {
            background-color: #4c1d95;
            /* Darker shade of purple */
        }

        /* Hide change background button on mobile devices */
        @media (max-width: 768px) {
            #changeBackgroundBtn {
                display: none !important;
            }
        }

        /* Fix drawer width for mobile landscape mode */
        @media (max-width: 926px) and (orientation: landscape) {
            .drawer-side > .menu {
                width: 60% !important;
                max-width: 280px !important;
            }
        }

        /* Fix drawer width for mobile portrait mode */
        @media (max-width: 768px) and (orientation: portrait) {
            .drawer-side > .menu {
                width: 75% !important;
                max-width: 320px !important;
            }
        }
    </style>
</head>

<body style="padding: 10px;">
    <!-- Pending Approval Overlay -->
    <div id="pendingApprovalOverlay" class="hidden fixed inset-0 bg-white bg-opacity-80 backdrop-blur-sm z-[9999] flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-2xl p-8 max-w-md mx-4 border-2 border-purple-300">
            <div class="text-center">
                <svg class="mx-auto h-16 w-16 text-yellow-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Approval Pending</h2>
                <p class="text-gray-600 text-lg leading-relaxed">
                    Account's approval is still pending. When approved, you will be contacted. Thank you.
                </p>
            </div>
        </div>
    </div>

    <div class="drawer h-full">
        <input id="my-drawer" type="checkbox" class="drawer-toggle" />
        <div class="drawer-content">
            <!-- Page content here -->
            <div class="navbar bg-neutral text-neutral-content">
                <div class="navbar-start">
                    <label for="my-drawer" class="btn btn-ghost btn-circle drawer-button">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6h16M4 12h16M4 18h7" />
                        </svg>
                    </label>
                </div>
                <div class="navbar-center">
                    <a class="btn btn-ghost text-xl" onclick="openSuperUserModal()">House Of Tutors</a>
                </div>
                <div class="navbar-end">
                    <button class="btn btn-ghost btn-circle" onclick="openEditProfileModal()" title="Edit Profile">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </button>
                    <button class="btn btn-ghost btn-circle" onclick="openAdminDetailsModal()" title="View Dashboard Details">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                    </button>
                    <button class="btn btn-ghost btn-circle" onclick="openLogoutModal()">
                        <img src="img/logout.png" alt="logout" class="h-5 w-5">
                    </button>
                </div>
            </div>

            <!-- Dynamic Cards Container -->
            <div id="classroomContainer" class="flex flex-wrap gap-4 mt-5"></div>

            <!-- VR Modal -->
            <div id="vrModal" class="modal modal-close">
                <div class="modal-box w-full h-full max-w-full">
                    <div class="modal-header">
                        <h2 class="text-2xl">Join VR Class</h2>
                        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2"
                            onclick="closeModal()">✕</button>
                    </div>
                    <div style="height:100%; width:100%" class="modal-body">
                        <iframe style="height:90%; width:100%" id="vrIframe" src="" allow="camera; microphone"></iframe>
                    </div>
                </div>
            </div>

            <!-- Edit Classroom Modal -->
            <div id="editClassroomModal" class="modal modal-close">
                <div class="modal-box">
                    <h2 class="text-xl">Edit Classroom Name</h2>
                    <input type="text" id="newClassroomName" class="input input-bordered w-full mt-4"
                        placeholder="New Classroom Name">
                    <div class="modal-action">
                        <button class="btn btn-primary" onclick="confirmEditClassroom()">Done</button>
                        <button class="btn" onclick="closeEditClassroomModal()">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Delete Classroom Modal -->
            <div id="deleteClassroomModal" class="modal modal-close">
                <div class="modal-box">
                    <h2 class="text-xl">Do you want to delete this classroom?</h2>
                    <div class="modal-action">
                        <button class="btn btn-primary" onclick="confirmDeleteClassroom()">Yes</button>
                        <button class="btn" onclick="closeDeleteClassroomModal()">No</button>
                    </div>
                </div>
            </div>

            <!-- Logout Confirmation Modal -->
            <div id="logoutModal" class="modal">
                <div class="modal-box">
                    <h2 class="text-xl">Do you want to log out?</h2>
                    <div class="modal-action">
                        <button class="btn btn-primary" onclick="confirmLogout()">Yes</button>
                        <button class="btn" onclick="closeLogoutModal()">No</button>
                    </div>
                </div>
            </div>

            <!-- Super User Login Modal -->
            <div id="superUserModal" class="modal">
                <div class="modal-box">
                    <h2 class="text-xl font-bold mb-4">Super User Login</h2>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Username</span>
                        </label>
                        <input type="text" id="superUsername" placeholder="Enter username" class="input input-bordered" />
                    </div>
                    <div class="form-control mt-4">
                        <label class="label">
                            <span class="label-text">Password</span>
                        </label>
                        <input type="password" id="superPassword" placeholder="Enter password" class="input input-bordered" />
                    </div>
                    <div id="superLoginError" class="text-red-500 text-sm mt-2 hidden">Invalid credentials!</div>
                    <div class="modal-action">
                        <button class="btn btn-primary" onclick="verifySuperUser()">Login</button>
                        <button class="btn" onclick="closeSuperUserModal()">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Admin Details Modal -->
            <div id="adminDetailsModal" class="modal">
                <div class="modal-box max-w-4xl">
                    <h2 class="text-2xl font-bold mb-4 text-purple-800">Dashboard Details</h2>
                    <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="closeAdminDetailsModal()">✕</button>
                    
                    <!-- Summary Section -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="stat bg-purple-100 rounded-lg shadow">
                            <div class="stat-title">Total Classrooms</div>
                            <div class="stat-value text-purple-800" id="totalClassrooms">0</div>
                        </div>
                        <div class="stat bg-purple-100 rounded-lg shadow">
                            <div class="stat-title">Total Students</div>
                            <div class="stat-value text-purple-800" id="totalStudents">0</div>
                        </div>
                    </div>

                    <!-- Students Details Section -->
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-3 text-purple-700">My Students</h3>
                        <div class="overflow-x-auto">
                            <table class="table table-zebra w-full">
                                <thead>
                                    <tr>
                                        <th>Full Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                    </tr>
                                </thead>
                                <tbody id="studentsTableBody">
                                    <tr><td colspan="3" class="text-center">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="modal-action">
                        <button class="btn btn-primary" onclick="closeAdminDetailsModal()">Close</button>
                    </div>
                </div>
            </div>

            <!-- Edit Profile Modal -->
            <div id="editProfileModal" class="modal">
                <div class="modal-box max-w-4xl max-h-[90vh] overflow-y-auto">
                    <h2 class="text-2xl font-bold mb-4 text-purple-800">Edit Profile</h2>
                    <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="closeEditProfileModal()">✕</button>
                    
                    <form id="editProfileForm" class="space-y-4">
                        <!-- Profile Picture Section -->
                        <div class="flex flex-col items-center mb-6 p-4 bg-gray-50 rounded-lg">
                            <label class="block text-sm font-medium text-gray-900 mb-3">Profile Picture</label>
                            <div class="relative">
                                <img id="editProfilePicturePreview" 
                                     src="img/user-icon.png" 
                                     alt="Profile Picture" 
                                     class="w-32 h-32 rounded-full object-cover border-4 border-purple-600 shadow-lg">
                                <button type="button" 
                                        id="changeProfilePictureBtn" 
                                        class="absolute bottom-0 right-0 btn btn-circle btn-sm btn-primary shadow-lg"
                                        onclick="selectProfilePicture()"
                                        title="Change Profile Picture">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                </button>
                            </div>
                            <input type="file" 
                                   id="profilePictureInput" 
                                   accept="image/jpeg,image/png,image/jpg,image/gif,image/webp" 
                                   class="hidden" 
                                   onchange="previewProfilePicture(event)">
                            <p class="text-xs text-gray-500 mt-2">Click the camera icon to upload a new picture (max 5MB)</p>
                            <div id="uploadProgress" class="hidden mt-2 w-full">
                                <div class="text-sm text-center mb-1" id="uploadProgressText">Uploading: 0%</div>
                                <progress class="progress progress-primary w-full" value="0" max="100" id="uploadProgressBar"></progress>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="editFullName" class="block text-sm font-medium text-gray-900 mb-1">Full Name *</label>
                                <input type="text" id="editFullName" required
                                    class="bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5">
                            </div>
                            <div>
                                <label for="editEmail" class="block text-sm font-medium text-gray-900 mb-1">Email *</label>
                                <input type="email" id="editEmail" required readonly
                                    class="bg-gray-100 border border-gray-300 text-gray-900 rounded-lg block w-full p-2.5 cursor-not-allowed">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="editPhone" class="block text-sm font-medium text-gray-900 mb-1">Phone *</label>
                                <input type="tel" id="editPhone" required
                                    class="bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5">
                            </div>
                            <div>
                                <label for="editFees" class="block text-sm font-medium text-gray-900 mb-1">Fees (per month) *</label>
                                <input type="number" id="editFees" required min="0" step="0.01"
                                    class="bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5">
                            </div>
                        </div>

                        <div>
                            <label for="editTeachingLevel" class="block text-sm font-medium text-gray-900 mb-2">Select Teaching Level *</label>
                            <select id="editTeachingLevel" required
                                class="bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5">
                                <option value="">Select Level</option>
                                <option value="primary">Primary</option>
                                <option value="secondary">Secondary</option>
                                <option value="tertiary">Tertiary</option>
                                <option value="others">Others</option>
                            </select>
                        </div>

                        <div id="editSubjectsContainer">
                            <label class="block text-sm font-medium text-gray-900 mb-2">Subjects to Teach (Select up to 3) *</label>
                            <div class="space-y-2">
                                <select id="editSubject1" required
                                    class="bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5">
                                    <option value="">First, select a teaching level above</option>
                                </select>
                                <select id="editSubject2"
                                    class="bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5">
                                    <option value="">Select Subject 2 (Optional)</option>
                                </select>
                                <select id="editSubject3"
                                    class="bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5">
                                    <option value="">Select Subject 3 (Optional)</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label for="editBio" class="block text-sm font-medium text-gray-900 mb-1">Bio (min 50 characters) *</label>
                            <textarea id="editBio" required minlength="50" rows="3"
                                class="bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5"
                                placeholder="Tell us about your teaching experience, qualifications, and what makes you a great tutor..."></textarea>
                            <p class="text-xs text-gray-500 mt-1" id="editBioCharCount">0 characters (minimum 50)</p>
                        </div>

                        <div>
                            <label for="editReason" class="block text-sm font-medium text-gray-900 mb-1">Reason to Join (min 15 characters) *</label>
                            <textarea id="editReason" required minlength="15" rows="3"
                                class="bg-gray-50 border border-gray-300 text-gray-900 rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5"
                                placeholder="Why did you join as a tutor..."></textarea>
                            <p class="text-xs text-gray-500 mt-1" id="editReasonCharCount">0 characters (minimum 15)</p>
                        </div>

                        <div id="editProfileError" class="hidden p-3 rounded-lg bg-red-100 border border-red-400">
                            <p class="text-sm text-red-800" id="editProfileErrorText"></p>
                        </div>

                        <div class="modal-action">
                            <button type="button" class="btn" onclick="closeEditProfileModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary" id="saveProfileBtn">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>

        </div>
        <div class="drawer-side">
            <label for="my-drawer" aria-label="close sidebar" class="drawer-overlay"></label>
            <div class="menu p-4 w-80 min-h-full bg-base-100 text-base-content relative">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Menu</h2>
                    <label for="my-drawer" class="btn btn-ghost btn-circle drawer-button">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </label>
                </div>
                <ul class="space-y-2 divide-y divide-gray-300">
                    <li><a href="AddStudentToClassroom.html" class="block py-2 px-4">Add Student to Classroom</a></li>
                    <li><a href="AddCommentToClassroom.html" class="block py-2 px-4">Add Comment to Classroom</a></li>
                    <li><a href="AddFeedbackToStudent.html" class="block py-2 px-4">Add Feedback to Student</a></li>
                    <li><a href="CreateClassroom.html" class="block py-2 px-4">Create New Classroom</a></li>
                    <li><a href="CreateStudent.html" class="block py-2 px-4">Create New Student</a></li>
                    <li><a href="ModifyStudentDetails.html" class="block py-2 px-4">Edit Student Details</a></li>
                    <li><a href="RemoveStudentFromClassroom.html" class="block py-2 px-4">Remove Student From a
                            Classroom</a></li>
                </ul>
                <hr class="mt-10 mb-10 border-black" />
                <ul class="space-y-2 divide-y divide-gray-300">
                    <li><a href="MyTimeTable.html" class="block py-2 px-4">My TimeTable</a></li>
                    <li><a href="StudentAttendance.html" class="block py-2 px-4">Attendance</a></li>
                    <li><a href="Whiteboard.html" class="block py-2 px-4">Whiteboard</a></li>
                </ul>
                
                <!-- Customer Support Icon -->
                <div class="absolute bottom-4 left-4">
                    <button id="customerSupportBtn" class="btn btn-circle btn-primary shadow-lg" onclick="toggleSupportInfo()" title="Customer Support">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                    </button>
                    <!-- Support Info Box -->
                    <div id="supportInfoBox" class="hidden absolute bottom-16 left-0 bg-white shadow-xl rounded-lg p-4 w-72 border-2 border-purple-600 z-50">
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="text-lg font-bold text-purple-800">Need Help?</h3>
                            <button onclick="toggleSupportInfo()" class="btn btn-ghost btn-xs btn-circle">✕</button>
                        </div>
                        <div class="space-y-3">
                            <div class="flex items-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                </svg>
                                <div>
                                    <p class="text-xs text-gray-500">Email</p>
                                    <a href="mailto:ajtaroo@gmail.com" class="text-sm font-medium text-purple-700 hover:underline">ajtaroo@gmail.com</a>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                </svg>
                                <div>
                                    <p class="text-xs text-gray-500">WhatsApp</p>
                                    <a href="https://wa.me/23057882383" target="_blank" class="text-sm font-medium text-green-700 hover:underline">+23057882383</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Background Selection Modal -->
    <div id="backgroundModal" class="modal">
        <div class="modal-box">
            <h2 class="text-xl font-bold mb-4">Choose a Background</h2>
            <div id="backgroundOptions" class="grid grid-cols-3 gap-4">
                <!-- Background options will be dynamically added here -->
            </div>
            <div class="modal-action">
                <button class="btn" onclick="closeBackgroundModal()">Cancel</button>
            </div>
        </div>
    </div>

    <button id="changeBackgroundBtn" class="btn btn-primary shadow-lg fixed bottom-5 right-5 z-50 rounded-lg px-4 py-2"
        onclick="openBackgroundModal()">
        Change Background
    </button>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getDatabase, ref, get, onValue, update, remove, push, set } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-storage.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCwol-nlbl1YbdAiU88nYFv67pJg2XOo9U",
            authDomain: "houseoftutors-f398e.firebaseapp.com",
            databaseURL: "https://houseoftutors-f398e-default-rtdb.firebaseio.com/",
            projectId: "houseoftutors-f398e",
            storageBucket: "houseoftutors-f398e.firebasestorage.app",
            messagingSenderId: "1006665226128",
            appId: "1:1006665226128:web:bcf481758d361da3ef8515",
            measurementId: "G-PEM636J9ZD"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const storage = getStorage(app);

        let selectedClassroomId = null;

        // Retrieve the email from local storage
        const email = localStorage.getItem('userEmail');

        // Check approval status and show overlay if pending
        const approvalStatus = localStorage.getItem('adminApproval');
        if (approvalStatus === 'pending') {
            // Show the pending approval overlay
            document.getElementById('pendingApprovalOverlay').classList.remove('hidden');
            
            // Disable drawer toggle
            const drawerToggle = document.getElementById('my-drawer');
            if (drawerToggle) {
                drawerToggle.disabled = true;
            }
            
            // Disable all interactive elements
            const drawerButtons = document.querySelectorAll('.drawer-button');
            drawerButtons.forEach(btn => {
                btn.style.pointerEvents = 'none';
                btn.style.opacity = '0.5';
            });
            
            // Disable navbar buttons
            const navbarButtons = document.querySelectorAll('.navbar button');
            navbarButtons.forEach(btn => {
                btn.style.pointerEvents = 'none';
                btn.style.opacity = '0.5';
            });
            
            // Prevent all clicks on the page
            document.body.style.pointerEvents = 'none';
            // But allow pointer events on the overlay itself
            document.getElementById('pendingApprovalOverlay').style.pointerEvents = 'auto';
        }

        // Function to capture and log admin dashboard information
        // Logging functionality removed as per requirement

        // Function to check if device is mobile
        function isMobileDevice() {
            return window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // Function to detect dark mode preference
        function isDarkMode() {
            return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        }

        // Function to apply mobile background
        function applyMobileBackground() {
            if (isMobileDevice()) {
                // Clear any wallpaper image
                document.body.style.backgroundImage = 'none';
                
                // Apply white or black based on dark mode preference
                if (isDarkMode()) {
                    document.body.style.backgroundColor = '#000000'; // Black for dark mode
                } else {
                    document.body.style.backgroundColor = '#ffffff'; // White for light mode
                }
                
                document.body.style.backgroundSize = 'auto';
                document.body.style.backgroundPosition = 'initial';
                document.body.style.backgroundRepeat = 'initial';
                document.body.style.backgroundAttachment = 'initial';
                document.body.style.height = '100vh';
                document.body.style.margin = '0';
                
                console.log('Mobile device detected - Applied ' + (isDarkMode() ? 'black' : 'white') + ' background');
            }
        }

        // Load the saved wallpaper on page load
        if (email) {
            const adminRef = ref(database, "ADMIN");
            get(adminRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const admins = snapshot.val();
                    
                    // Check if mobile device first
                    if (isMobileDevice()) {
                        applyMobileBackground();
                    } else {
                        // Only apply wallpaper on desktop
                        for (const key in admins) {
                            if (admins[key].EMAIL === email && admins[key].WALLPAPER) {
                                const savedWallpaper = admins[key].WALLPAPER;
                                document.body.style.backgroundImage = `url('${savedWallpaper}')`;
                                document.body.style.backgroundSize = 'cover';
                                document.body.style.backgroundPosition = 'center';
                                document.body.style.backgroundRepeat = 'no-repeat';
                                document.body.style.backgroundAttachment = 'fixed';
                                document.body.style.height = '100vh';
                                document.body.style.margin = '0';
                                break;
                            }
                        }
                    }
                }
            }).catch((error) => {
                console.error('Error retrieving admin data:', error);
                // Still apply mobile background if on mobile
                if (isMobileDevice()) {
                    applyMobileBackground();
                }
            });
        } else {
            // If no email, still apply mobile background if on mobile
            if (isMobileDevice()) {
                applyMobileBackground();
            }
        }

        // Listen for dark mode changes on mobile
        if (window.matchMedia) {
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (isMobileDevice()) {
                    applyMobileBackground();
                }
            });
        }

        if (email) {
            // Find the admin with the matching email and retrieve VIRTUAL_ROOMS
            const adminRef = ref(database, "ADMIN");
            get(adminRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const admins = snapshot.val();
                    let virtualRooms = [];
                    let adminVrLink = '';
                    for (const key in admins) {
                        if (admins[key].EMAIL === email) {
                            virtualRooms = admins[key].VIRTUAL_ROOMS ? admins[key].VIRTUAL_ROOMS.split(',') : [];
                            adminVrLink = admins[key].VR_LINK || '';
                            break;
                        }
                    }

                    // Convert virtualRooms to numbers
                    const allowedClassroomIds = virtualRooms.map(Number);

                    // Reference to the CLASSROOMS node
                    const classroomsRef = ref(database, "CLASSROOMS");

                    // Fetch data and populate cards
                    const classroomContainer = document.getElementById("classroomContainer");

                    onValue(classroomsRef, (snapshot) => {
                        const classrooms = snapshot.val();

                        // Clear existing content
                        classroomContainer.innerHTML = "";

                        // Iterate over classrooms and filter by allowed IDs
                        Object.values(classrooms).forEach((classroom) => {
                            if (allowedClassroomIds.includes(classroom.CLASSROOM_ID)) {
                                // Use admin's VR_LINK instead of classroom's VR_LINK
                                const classroomLink = adminVrLink || "#";
                                // Create the card
                                const card = document.createElement("div");
                                card.className = "card bg-purple-800 text-white w-full sm:w-96 h-auto sm:h-64 shadow-lg cursor-pointer"; // Adjust width and height for responsiveness
                                card.innerHTML = `
                                <div class="card-body flex flex-col justify-between">
                                    <div class="flex flex-row justify-between items-start sm:items-center">
                                        <h3 class="card-title text-lg sm:text-2xl font-bold edit-title-btn">${classroom.TITLE}</h3>
                                        <div class="dropdown dropdown-end">
                                            <label tabindex="0" class="btn btn-ghost btn-circle dropdown-toggle-btn">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="white">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6h.01M12 12h.01M12 18h.01" />
                                                </svg>
                                            </label>
                                            <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52 text-base-content">
                                                <li><a class="delete-classroom-btn">Delete Classroom</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="card-actions justify-center space-x-2 mt-4 flex flex-col items-center sm:flex-row sm:items-start">
                                        <button class="btn btn-outline text-white border-white w-full sm:w-auto join-vr-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M4 6h16M4 12h16M4 18h7" />
                                            </svg>
                                            Join VR Class
                                        </button>
                                        <button class="btn btn-outline text-white border-white w-full sm:w-auto view-notes-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v8m4-4H8m8 4H8m8-8H8m8-4H8m8 4H8m8 4H8m8 4H8m8 4H8m8 4H8" />
                                            </svg>
                                            View Notes
                                        </button>
                                        <button class="btn btn-circle btn-sm btn-outline text-white border-white mt-2 sm:mt-0 upload-notes-btn">+</button>
                                    </div>
                                </div>
                            `;
                                
                                // Add event listeners after creating the card
                                const cardBody = card.querySelector('.card-body');
                                const editTitleBtn = card.querySelector('.edit-title-btn');
                                const dropdownToggleBtn = card.querySelector('.dropdown-toggle-btn');
                                const deleteClassroomBtn = card.querySelector('.delete-classroom-btn');
                                const joinVrBtn = card.querySelector('.join-vr-btn');
                                const viewNotesBtn = card.querySelector('.view-notes-btn');
                                const uploadNotesBtn = card.querySelector('.upload-notes-btn');
                                
                                // Card body click - redirect to comments
                                cardBody.addEventListener('click', () => {
                                    redirectToClassroomCommentAdmin(classroom.CLASSROOM_ID, email);
                                });
                                
                                // Edit title - prevent propagation and open edit modal
                                editTitleBtn.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    openEditClassroomModal(classroom.CLASSROOM_ID);
                                });
                                
                                // Dropdown toggle - prevent propagation
                                dropdownToggleBtn.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                });
                                
                                // Delete classroom - prevent propagation and open delete modal
                                deleteClassroomBtn.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    openDeleteClassroomModal(classroom.CLASSROOM_ID);
                                });
                                
                                // Join VR button - prevent propagation and open modal
                                joinVrBtn.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    openModal(classroomLink, classroom.CLASSROOM_ID, classroom.TITLE);
                                });
                                
                                // View Notes button - prevent propagation and store folder
                                viewNotesBtn.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    storeStorageFolder(classroom.STORAGE_FOLDER);
                                });
                                
                                // Upload Notes button - prevent propagation and redirect
                                uploadNotesBtn.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    redirectToUploadNotes(classroom.CLASSROOM_ID);
                                });
                                
                                // Append the card to the container
                                classroomContainer.appendChild(card);
                            } 
                        });
                    });
                } else {
                    console.error("No admin data available");
                }
            }).catch((error) => {
                console.error("Error retrieving admin data:", error);
            });
        } else {
            console.error("No email found in local storage");
        }

        // Define the function in the global scope
        window.storeStorageFolder = function (storageFolder) {
            localStorage.setItem('storage_folder', storageFolder);
            window.location.href = 'LoadNotesAdmin.html'; // Redirect to notes.html
        };

        window.openModal = async function (url, classroomId, classroomTitle) {
            // Validate VR link before opening
            if (!url || url.trim() === '' || url.trim() === '#') {
                alert('VR Link is not configured for this classroom. Please set up the VR link in your admin profile first.');
                return;
            }
            
            // Log the VR classroom join action
            const adminEmail = localStorage.getItem('userEmail');
            if (adminEmail) {
                try {
                    const adminRef = ref(database, "ADMIN");
                    const adminSnapshot = await get(adminRef);
                    if (adminSnapshot.exists()) {
                        const admins = adminSnapshot.val();
                        for (const key in admins) {
                            if (admins[key].EMAIL === adminEmail) {
                                const logData = {
                                    CLASSROOM_ID: classroomId,
                                    CLASSROOM_TITLE: classroomTitle,
                                    TIMESTAMP: Date.now(),
                                    DATE: new Date().toISOString()
                                };
                                await set(ref(database, `ADMIN/${key}/LOGS/LAST_JOINED_VR_CLASSROOM`), logData);
                                break;
                            }
                        }
                    }
                } catch (error) {
                    console.error("Error logging VR classroom join:", error);
                }
            }
            
            window.open(`OnlineClass.html?vrLink=${encodeURIComponent(url)}`, '_blank');
        };

        window.closeModal = function () {
            document.getElementById('vrIframe').src = '';
            document.getElementById('vrModal').classList.remove('modal-open');
        };

        window.openLogoutModal = function () {
            document.getElementById('logoutModal').classList.add('modal-open');
        };

        window.closeLogoutModal = function () {
            document.getElementById('logoutModal').classList.remove('modal-open');
        };

        window.confirmLogout = function () {
            window.location.replace("Login.html#admin");
        };

        window.redirectToUploadNotes = function (classroomId) {
            localStorage.setItem('CLASSROOM_ID', classroomId);
            window.location.href = 'UploadNotes.html';
        };

        window.redirectToClassroomCommentAdmin = function (classroomId, email) {
            localStorage.setItem('CLASSROOM_ID', classroomId);
            localStorage.setItem('userEmail', email);
            window.location.href = 'ClassroomCommentAdmin.html';
        };

        window.openEditClassroomModal = function (classroomId) {
            selectedClassroomId = classroomId;
            document.getElementById('newClassroomName').value = ''; // Clear the input field
            document.getElementById('editClassroomModal').classList.add('modal-open');
        };

        window.closeEditClassroomModal = function () {
            document.getElementById('editClassroomModal').classList.remove('modal-open');
        };

        window.confirmEditClassroom = function () {
            const newClassroomName = document.getElementById('newClassroomName').value;
            if (selectedClassroomId && newClassroomName) {
                const classroomRef = ref(database, `CLASSROOMS/CLASSROOM_${selectedClassroomId}`);
                update(classroomRef, {
                    TITLE: newClassroomName
                }).then(() => {
                    alert('Classroom name updated successfully!');
                    closeEditClassroomModal();
                }).catch((error) => {
                    console.error('Error updating classroom name:', error);
                });
            }
        };

        window.openDeleteClassroomModal = function (classroomId) {
            selectedClassroomId = classroomId;
            document.getElementById('deleteClassroomModal').classList.add('modal-open');
        };

        window.closeDeleteClassroomModal = function () {
            document.getElementById('deleteClassroomModal').classList.remove('modal-open');
        };

        window.confirmDeleteClassroom = async function () {
            if (selectedClassroomId) {
                try {
                    // Delete the classroom from CLASSROOMS node
                    const classroomRef = ref(database, `CLASSROOMS/CLASSROOM_${selectedClassroomId}`);
                    await remove(classroomRef);

                    // Remove classroom ID from all admins' VIRTUAL_ROOMS
                    const adminRef = ref(database, "ADMIN");
                    const adminSnapshot = await get(adminRef);
                    if (adminSnapshot.exists()) {
                        const admins = adminSnapshot.val();
                        for (const key in admins) {
                            const virtualRoomsStr = admins[key].VIRTUAL_ROOMS || '';
                            const virtualRooms = virtualRoomsStr ? virtualRoomsStr.split(',') : [];
                            if (virtualRooms.includes(selectedClassroomId.toString())) {
                                const updatedRooms = virtualRooms.filter(roomId => roomId !== selectedClassroomId.toString());
                                await update(ref(database, `ADMIN/${key}`), { VIRTUAL_ROOMS: updatedRooms.join(',') });
                            }
                        }
                    }

                    // Remove classroom ID from all students' VIRTUAL_ROOMS
                    const studentsRef = ref(database, "STUDENTS");
                    const studentsSnapshot = await get(studentsRef);
                    if (studentsSnapshot.exists()) {
                        const students = studentsSnapshot.val();
                        for (const studentKey in students) {
                            const virtualRoomsStr = students[studentKey].VIRTUAL_ROOMS || '';
                            const virtualRooms = virtualRoomsStr ? virtualRoomsStr.split(',') : [];
                            if (virtualRooms.includes(selectedClassroomId.toString())) {
                                const updatedRooms = virtualRooms.filter(roomId => roomId !== selectedClassroomId.toString());
                                await update(ref(database, `STUDENTS/${studentKey}`), { VIRTUAL_ROOMS: updatedRooms.join(',') });
                            }
                        }
                    }

                    alert('Classroom deleted successfully!');
                    closeDeleteClassroomModal();
                } catch (error) {
                    console.error('Error deleting classroom:', error);
                    alert('Error deleting classroom. Please try again.');
                }
            }
        };

        // Open the background selection modal
        window.openBackgroundModal = function () {
            document.getElementById('backgroundModal').classList.add('modal-open');
        };

        // Close the background selection modal
        window.closeBackgroundModal = function () {
            document.getElementById('backgroundModal').classList.remove('modal-open');
        };

        // Dynamically load wallpapers from the img/wallpapers folder
        const wallpapers = [
            'img/wallpapers/wallpaper1.png',
            'img/wallpapers/wallpaper2.png',
            'img/wallpapers/wallpaper3.png',
            'img/wallpapers/wallpaper4.png',
            'img/wallpapers/wallpaper5.png',
            'img/wallpapers/wallpaper6.png'
        ];

        const backgroundContainer = document.getElementById('backgroundOptions');
        backgroundContainer.innerHTML = ''; // Clear any existing content

        wallpapers.forEach((wallpaper) => {
            const img = document.createElement('img');
            img.src = wallpaper;
            img.className = 'w-full h-32 object-cover cursor-pointer rounded-lg border-2 border-transparent hover:border-blue-500';
            img.onclick = () => selectBackground(wallpaper);
            backgroundContainer.appendChild(img);
        });

        // Handle background selection
        window.selectBackground = function (wallpaper) {
            document.body.style.backgroundImage = `url('${wallpaper}')`;
            document.body.style.backgroundSize = 'cover'; // Ensures the image covers the entire screen
            document.body.style.backgroundPosition = 'center'; // Centers the image
            document.body.style.backgroundRepeat = 'no-repeat'; // Prevents the image from repeating
            document.body.style.backgroundAttachment = 'fixed'; // Keeps the background fixed during scrolling
            document.body.style.height = '100vh'; // Ensures the body height matches the viewport height
            document.body.style.margin = '0'; // Removes any default margin

            // Save the selected wallpaper to Firebase
            if (email) {
                const adminRef = ref(database, "ADMIN");
                get(adminRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        const admins = snapshot.val();
                        let adminKey = null;

                        // Find the admin node
                        for (const key in admins) {
                            if (admins[key].EMAIL === email) {
                                adminKey = key;
                                break;
                            }
                        }

                        if (adminKey) {
                            // Update the wallpaper in the database
                            const adminWallpaperRef = ref(database, `ADMIN/${adminKey}`);
                            update(adminWallpaperRef, { WALLPAPER: wallpaper }).then(() => {
                                console.log('Wallpaper updated successfully in Firebase!');
                            }).catch((error) => {
                                console.error('Error updating wallpaper in Firebase:', error);
                            });
                        }
                    }
                }).catch((error) => {
                    console.error('Error retrieving admin data:', error);
                });
            }

            closeBackgroundModal();
        };

        // Super User Modal Functions
        window.openSuperUserModal = function () {
            document.getElementById('superUserModal').classList.add('modal-open');
            document.getElementById('superUsername').value = '';
            document.getElementById('superPassword').value = '';
            document.getElementById('superLoginError').classList.add('hidden');
        };

        window.closeSuperUserModal = function () {
            document.getElementById('superUserModal').classList.remove('modal-open');
        };

        window.verifySuperUser = function () {
            const username = document.getElementById('superUsername').value;
            const password = document.getElementById('superPassword').value;
            
            if (username === 'admin' && password === 'admin123') {
                // Store super user flag
                localStorage.setItem('superUserAuth', 'true');
                // Redirect to info.html
                window.location.href = 'info.html';
            } else {
                document.getElementById('superLoginError').classList.remove('hidden');
            }
        };

        // Admin Details Modal Functions
        window.openAdminDetailsModal = async function () {
            document.getElementById('adminDetailsModal').classList.add('modal-open');
            await loadAdminDetails();
        };

        window.closeAdminDetailsModal = function () {
            document.getElementById('adminDetailsModal').classList.remove('modal-open');
        };

        // Customer Support Toggle Function
        window.toggleSupportInfo = function () {
            const supportBox = document.getElementById('supportInfoBox');
            if (supportBox.classList.contains('hidden')) {
                supportBox.classList.remove('hidden');
            } else {
                supportBox.classList.add('hidden');
            }
        };

        // Load and display admin details
        async function loadAdminDetails() {
            if (!email) {
                console.error('No email found in local storage');
                return;
            }

            try {
                // Get admin data
                const adminRef = ref(database, "ADMIN");
                const adminSnapshot = await get(adminRef);
                
                if (!adminSnapshot.exists()) {
                    console.error('Admin data not found');
                    return;
                }

                const admins = adminSnapshot.val();
                let adminData = null;
                let adminKey = null;

                // Find the admin with matching email
                for (const key in admins) {
                    if (admins[key].EMAIL === email) {
                        adminData = admins[key];
                        adminKey = key;
                        break;
                    }
                }

                if (!adminData) {
                    console.error('Admin not found');
                    return;
                }

                // Get classroom and student IDs
                const virtualRoomsStr = adminData.VIRTUAL_ROOMS || '';
                const virtualRooms = virtualRoomsStr
                    .split(',')
                    .filter(room => room.trim())
                    .map(Number);
                
                const studentsStr = adminData.STUDENTS || '';
                const studentIds = studentsStr
                    .split(',')
                    .filter(id => id.trim());

                // Update totals
                document.getElementById('totalClassrooms').textContent = virtualRooms.length;
                document.getElementById('totalStudents').textContent = studentIds.length;

                // Fetch and display student details
                const studentsRef = ref(database, "STUDENTS");
                const studentsSnapshot = await get(studentsRef);
                const studentsTableBody = document.getElementById('studentsTableBody');
                studentsTableBody.innerHTML = '';

                if (studentsSnapshot.exists()) {
                    const students = studentsSnapshot.val();
                    let hasStudents = false;

                    // Default value constant
                    const NOT_AVAILABLE = 'N/A';
                    
                    for (const studentKey in students) {
                        if (studentIds.includes(studentKey)) {
                            hasStudents = true;
                            const student = students[studentKey];
                            const row = document.createElement('tr');
                            
                            // Create cells and use textContent to prevent XSS
                            const nameCell = document.createElement('td');
                            nameCell.textContent = student.FULL_NAME;
                            
                            const emailCell = document.createElement('td');
                            emailCell.textContent = student.EMAIL;
                            
                            const telCell = document.createElement('td');
                            telCell.textContent = student.TEL || NOT_AVAILABLE;
                            
                            row.appendChild(nameCell);
                            row.appendChild(emailCell);
                            row.appendChild(telCell);
                            
                            studentsTableBody.appendChild(row);
                        }
                    }

                    if (!hasStudents) {
                        studentsTableBody.innerHTML = '<tr><td colspan="3" class="text-center">No students found</td></tr>';
                    }
                } else {
                    studentsTableBody.innerHTML = '<tr><td colspan="3" class="text-center">No students found</td></tr>';
                }

            } catch (error) {
                console.error('Error loading admin details:', error);
            }
        }

        // Define available subjects for each level (same as Login.html)
        const subjectsByLevel = {
            primary: [
                'Mathematics', 'English', 'Science', 'History', 'Geography',
                'Art and Design', 'Music', 'Physical Education'
            ],
            secondary: [
                'Mathematics', 'Physics', 'Chemistry', 'Biology', 'English',
                'French', 'History', 'Geography', 'Economics', 'Accounting',
                'Business Studies', 'Computer Science', 'Art and Design',
                'Arabic', 'Music'
            ],
            tertiary: [
                'Mathematics', 'Physics', 'Chemistry', 'Biology', 'English',
                'Computer Science', 'Economics', 'Accounting', 'Business Studies',
                'Engineering', 'Medicine', 'Law'
            ],
            others: [
                'Mathematics', 'Physics', 'Chemistry', 'Biology', 'English',
                'French', 'History', 'Geography', 'Economics', 'Accounting',
                'Business Studies', 'Computer Science', 'Art and Design',
                'Arabic', 'Music'
            ]
        };

        // Edit Profile Modal Functions
        window.openEditProfileModal = async function () {
            document.getElementById('editProfileModal').classList.add('modal-open');
            await loadEditProfileData();
        };

        window.closeEditProfileModal = function () {
            document.getElementById('editProfileModal').classList.remove('modal-open');
        };

        // Load admin data into edit form
        async function loadEditProfileData() {
            if (!email) {
                console.error('No email found in local storage');
                return;
            }

            try {
                // Reset form to initial state before loading data
                // This ensures previous values don't persist
                document.getElementById('editProfileForm').reset();
                
                // Reset profile picture to default
                const profilePictureElement = document.getElementById('editProfilePicturePreview');
                profilePictureElement.src = 'img/user-icon.png';
                
                // Reset teaching level dropdown to default
                document.getElementById('editTeachingLevel').value = '';
                
                // Reset subject dropdowns to initial state
                populateEditSubjectDropdowns('');
                
                const adminRef = ref(database, "ADMIN");
                const adminSnapshot = await get(adminRef);
                
                if (!adminSnapshot.exists()) {
                    console.error('Admin data not found');
                    return;
                }

                const admins = adminSnapshot.val();
                let adminData = null;
                let adminKey = null;

                // Find the admin with matching email
                for (const key in admins) {
                    if (admins[key].EMAIL === email) {
                        adminData = admins[key];
                        adminKey = key;
                        break;
                    }
                }

                if (!adminData) {
                    console.error('Admin not found');
                    return;
                }

                // Store adminKey for later use
                window.currentAdminKey = adminKey;

                // Populate form fields
                document.getElementById('editFullName').value = adminData.FULL_NAME || '';
                document.getElementById('editEmail').value = adminData.EMAIL || '';
                document.getElementById('editPhone').value = adminData.TEL || '';
                document.getElementById('editFees').value = adminData.FEES || '';
                document.getElementById('editBio').value = adminData.BIO || '';
                document.getElementById('editReason').value = adminData.REASON || '';
                
                // Update character counts
                updateCharCount('editBio', 'editBioCharCount');
                updateCharCount('editReason', 'editReasonCharCount');

                // Set teaching level
                const teachingLevel = adminData.LEVELS || '';
                document.getElementById('editTeachingLevel').value = teachingLevel;

                // Load profile picture if exists
                if (adminData.PROFILE_PICTURE) {
                    // Add cache-busting parameter and error handling
                    const imageUrl = adminData.PROFILE_PICTURE;
                    
                    // Set up handlers before changing src
                    profilePictureElement.onload = function() {
                        console.log('Profile picture loaded successfully');
                    };
                    
                    profilePictureElement.onerror = function() {
                        console.error('Failed to load profile picture:', imageUrl);
                        // Clear handlers to prevent infinite loop
                        profilePictureElement.onload = null;
                        profilePictureElement.onerror = null;
                        // Fallback to default image
                        profilePictureElement.src = 'img/user-icon.png';
                    };
                    
                    // Add cache-busting parameter to force reload
                    const cacheBuster = imageUrl.includes('?') ? '&' : '?';
                    profilePictureElement.src = imageUrl + cacheBuster + 't=' + Date.now();
                } else {
                    // Explicitly set to default image (already set above, but be explicit for clarity)
                    profilePictureElement.src = 'img/user-icon.png';
                }

                // Always populate subject dropdowns based on teaching level
                // This ensures dropdowns are properly initialized even if empty
                populateEditSubjectDropdowns(teachingLevel);
                
                // Set selected subjects if they exist
                if (teachingLevel && adminData.SUBJECTS) {
                    const subjects = adminData.SUBJECTS.split(',');
                    if (subjects[0]) document.getElementById('editSubject1').value = subjects[0].trim();
                    if (subjects[1]) document.getElementById('editSubject2').value = subjects[1].trim();
                    if (subjects[2]) document.getElementById('editSubject3').value = subjects[2].trim();
                }

            } catch (error) {
                console.error('Error loading edit profile data:', error);
                showEditProfileError('Error loading profile data. Please try again.');
            }
        }

        // Profile Picture Upload Functions
        let selectedProfilePictureFile = null;

        // Function to trigger file input
        window.selectProfilePicture = function() {
            document.getElementById('profilePictureInput').click();
        };

        // Function to preview selected profile picture
        window.previewProfilePicture = function(event) {
            const file = event.target.files[0];
            
            if (!file) {
                return;
            }
            
            // Validate file type
            const validTypes = ['image/jpeg', 'image/png', 'image/jpg', 'image/gif', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                showEditProfileError('Please select a valid image file (JPEG, PNG, GIF, or WebP)');
                event.target.value = '';
                return;
            }
            
            // Validate file size (max 5MB)
            const maxSize = 5 * 1024 * 1024; // 5MB in bytes
            if (file.size > maxSize) {
                showEditProfileError('File size must be less than 5MB');
                event.target.value = '';
                return;
            }
            
            // Store the file for upload
            selectedProfilePictureFile = file;
            
            // Preview the image
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('editProfilePicturePreview').src = e.target.result;
            };
            reader.readAsDataURL(file);
        };

        // Function to upload profile picture to Firebase Storage
        async function uploadProfilePicture() {
            if (!selectedProfilePictureFile) {
                return null; // No file selected, skip upload
            }
            
            return new Promise((resolve, reject) => {
                try {
                    // Create a unique filename using admin key and timestamp
                    const fileName = `profile_${window.currentAdminKey}_${Date.now()}.${selectedProfilePictureFile.name.split('.').pop()}`;
                    const fileRef = storageRef(storage, `ADMIN_PROFILE_PICTURES/${fileName}`);
                    
                    // Show progress bar
                    document.getElementById('uploadProgress').classList.remove('hidden');
                    
                    // Upload file
                    const uploadTask = uploadBytesResumable(fileRef, selectedProfilePictureFile);
                    
                    uploadTask.on('state_changed',
                        (snapshot) => {
                            // Update progress
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            document.getElementById('uploadProgressBar').value = progress;
                            document.getElementById('uploadProgressText').textContent = `Uploading: ${Math.floor(progress)}%`;
                        },
                        (error) => {
                            // Hide progress bar
                            document.getElementById('uploadProgress').classList.add('hidden');
                            console.error('Upload error:', error);
                            reject(error);
                        },
                        async () => {
                            // Upload completed successfully
                            try {
                                const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                                // Hide progress bar
                                document.getElementById('uploadProgress').classList.add('hidden');
                                resolve(downloadURL);
                            } catch (error) {
                                console.error('Error getting download URL:', error);
                                reject(error);
                            }
                        }
                    );
                } catch (error) {
                    console.error('Error starting upload:', error);
                    reject(error);
                }
            });
        }

        // Handle teaching level change in edit form
        document.getElementById('editTeachingLevel').addEventListener('change', (e) => {
            const level = e.target.value;
            populateEditSubjectDropdowns(level);
        });

        // Populate subject dropdowns based on level
        function populateEditSubjectDropdowns(level) {
            const subject1 = document.getElementById('editSubject1');
            const subject2 = document.getElementById('editSubject2');
            const subject3 = document.getElementById('editSubject3');
            
            // Clear all subject dropdowns
            [subject1, subject2, subject3].forEach(select => {
                select.innerHTML = '';
            });
            
            if (!level) {
                subject1.innerHTML = '<option value="">First, select a teaching level above</option>';
                subject2.innerHTML = '<option value="">Select Subject 2 (Optional)</option>';
                subject3.innerHTML = '<option value="">Select Subject 3 (Optional)</option>';
                return;
            }
            
            // Get subjects for selected level
            const subjects = subjectsByLevel[level] || [];
            
            // Populate subject1 (required)
            subject1.innerHTML = '<option value="">Select Subject 1</option>';
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                subject1.appendChild(option);
            });
            
            // Populate subject2 (optional)
            subject2.innerHTML = '<option value="">Select Subject 2 (Optional)</option>';
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                subject2.appendChild(option);
            });
            
            // Populate subject3 (optional)
            subject3.innerHTML = '<option value="">Select Subject 3 (Optional)</option>';
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                subject3.appendChild(option);
            });
        }

        // Update character count
        function updateCharCount(textareaId, countId) {
            const textarea = document.getElementById(textareaId);
            const count = document.getElementById(countId);
            const minLength = textarea.getAttribute('minlength') || 0;
            count.textContent = `${textarea.value.length} characters (minimum ${minLength})`;
        }

        // Add character count listeners
        document.getElementById('editBio').addEventListener('input', () => {
            updateCharCount('editBio', 'editBioCharCount');
        });

        document.getElementById('editReason').addEventListener('input', () => {
            updateCharCount('editReason', 'editReasonCharCount');
        });

        // Show edit profile error
        function showEditProfileError(message) {
            document.getElementById('editProfileErrorText').textContent = message;
            document.getElementById('editProfileError').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('editProfileError').classList.add('hidden');
            }, 5000);
        }

        // Handle edit profile form submission
        document.getElementById('editProfileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Get form values
            const fullName = document.getElementById('editFullName').value.trim();
            const phone = document.getElementById('editPhone').value.trim();
            const teachingLevel = document.getElementById('editTeachingLevel').value;
            const subject1 = document.getElementById('editSubject1').value;
            const subject2 = document.getElementById('editSubject2').value;
            const subject3 = document.getElementById('editSubject3').value;
            const fees = document.getElementById('editFees').value;
            const bio = document.getElementById('editBio').value.trim();
            const reason = document.getElementById('editReason').value.trim();
            
            // Validation
            if (!fullName || !phone || !teachingLevel || !subject1 || !fees || !bio || !reason) {
                showEditProfileError('Please fill in all required fields');
                return;
            }
            
            if (parseFloat(fees) <= 0 || isNaN(parseFloat(fees))) {
                showEditProfileError('Please enter a valid fee amount');
                return;
            }
            
            if (bio.length < 50) {
                showEditProfileError('Bio must be at least 50 characters long');
                return;
            }
            
            if (reason.length < 15) {
                showEditProfileError('Reason must be at least 15 characters long');
                return;
            }
            
            // Build subjects array
            const subjects = [subject1];
            if (subject2) subjects.push(subject2);
            if (subject3) subjects.push(subject3);
            
            // Disable submit button
            const submitBtn = document.getElementById('saveProfileBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';
            
            try {
                // Upload profile picture if one was selected
                let profilePictureUrl = null;
                if (selectedProfilePictureFile) {
                    try {
                        profilePictureUrl = await uploadProfilePicture();
                    } catch (uploadError) {
                        console.error('Error uploading profile picture:', uploadError);
                        showEditProfileError('Error uploading profile picture. Please try again.');
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Save Changes';
                        return;
                    }
                }
                
                // Prepare update data
                const updateData = {
                    FULL_NAME: fullName,
                    TEL: phone,
                    LEVELS: teachingLevel,
                    SUBJECTS: subjects.join(','),
                    FEES: parseFloat(fees),
                    BIO: bio,
                    REASON: reason
                };
                
                // Add profile picture URL if uploaded
                if (profilePictureUrl) {
                    updateData.PROFILE_PICTURE = profilePictureUrl;
                }
                
                // Update admin data
                const adminUpdateRef = ref(database, `ADMIN/${window.currentAdminKey}`);
                await update(adminUpdateRef, updateData);
                
                // Reset selected file
                selectedProfilePictureFile = null;
                document.getElementById('profilePictureInput').value = '';
                
                // Close modal and show success
                closeEditProfileModal();
                alert('Profile updated successfully!');
                
                // Reset button
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Changes';
                
            } catch (error) {
                console.error('Error updating profile:', error);
                showEditProfileError('An error occurred while updating your profile. Please try again.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Changes';
            }
        });
    </script>

</body>

</html>