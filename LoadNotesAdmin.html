<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Notes</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://code.jquery.com/jquery-latest.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-auth.js"></script>
  <style>
    body {
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    #notesContainer {
      flex: 1;
      overflow-y: auto;
      padding-bottom: 20px;
    }
    .alert img { border: 2px solid gray; border-radius: 8px; cursor: pointer; margin-right: 10px; }
    .alert { display: flex; align-items: center; margin-bottom: 10px; background-color: #f8f9fa;
             box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 8px; padding: 10px; position: relative; }
    .details { display: flex; flex-direction: column; padding-left: 10px; }
    .details .name { font-weight: bold; font-size: 1.2em; }
    .details .date { color: gray; font-size: 0.9em; }
    .details .separator { border-top: 1px solid #ddd; margin: 10px 0; }
    .delete-btn { position: absolute; top: 10px; right: 10px; cursor: pointer; color: red; }
    .delete-btn i { font-size: 1.5em; }
  </style>
</head>
<body style="height:100%" onload="readData()">
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <button class="btn btn-dark" onclick="window.location.href='DashboardAdmin.html'">
        <i class="fas fa-arrow-left"></i>
      </button>
      <a class="navbar-brand mx-auto" href="#">House Of Tutors</a>
    </div>
  </nav>

  <div class="container">
    <h2 class="mt-4 text-center">Uploaded Notes</h2>
    <div id="notesContainer"></div>
  </div>

  <!-- Preview Modal -->
  <div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content"><div class="modal-body"><img id="modalImage" style="width:100%;"></div></div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5>Confirm Deletion</h5></div>
        <div class="modal-body">Are you sure you want to delete this note?</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Yes</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    var firebaseConfig = {
      apiKey: "AIzaSyCwol-nlbl1YbdAiU88nYFv67pJg2XOo9U",
      authDomain: "houseoftutors-f398e.firebaseapp.com",
      databaseURL: "https://houseoftutors-f398e-default-rtdb.firebaseio.com",
      projectId: "houseoftutors-f398e",
      storageBucket: "houseoftutors-f398e.appspot.com",
      messagingSenderId: "1006665226128",
      appId: "1:1006665226128:web:bcf481758d361da3ef8515"
    };
    firebase.initializeApp(firebaseConfig);

    function getIconByExtension(filename) {
      if (!filename) return "img/uploadnote_icons/icon-img.png";
      let ext = filename.split('.').pop().toLowerCase();
      switch(ext) {
        case "pdf": return "img/uploadnote_icons/icon-pdf.png";
        case "doc": case "docx": return "img/uploadnote_icons/icon-docx.png";
        case "jpg": case "jpeg": case "png": case "gif": return "img/uploadnote_icons/icon-img.png";
        case "mp4": case "avi": case "mov": return "img/uploadnote_icons/icon-video.png";
        default: return "img/uploadnote_icons/icon-img.png";
      }
    }

    function readData() {
      var storageFolder = localStorage.getItem('storage_folder');
      if (!storageFolder) return;
      var itemsRef = firebase.database().ref(storageFolder);
      var notesContainer = document.getElementById('notesContainer');

      itemsRef.once('value', function(snapshot) {
        var items = [];
        snapshot.forEach(snap => items.push(snap.val()));
        items.sort((a,b) => b.ID - a.ID);

        notesContainer.innerHTML = "";

        items.forEach(function(item) {
          var alertDiv = document.createElement("div");
          alertDiv.className = "alert";

          var img = document.createElement("img");
          img.src = getIconByExtension(item.Name || item.Link);

          img.onclick = function() {
            if (/\.(jpg|jpeg|png|gif)$/i.test(item.Name)) {
              document.getElementById('modalImage').src = item.Link;
              $('#imageModal').modal('show');
            } else if (item.Name && item.Name.toLowerCase().endsWith(".pdf")) {
              localStorage.setItem('pdf_link', item.Link);
              window.location.href = 'PdfViewer.html';
            } else {
              window.open(item.Link, '_blank');
            }
          };
          alertDiv.appendChild(img);

          var detailsDiv = document.createElement("div");
          detailsDiv.className = "details";
          detailsDiv.innerHTML = `
            <span class="name">${item.Name || ("Note ID " + item.ID)}</span>
            <div class="separator"></div>
            <span class="date">Uploaded on: ${new Date(item.Time).toLocaleString()}</span>
          `;
          alertDiv.appendChild(detailsDiv);

          var deleteBtn = document.createElement("span");
          deleteBtn.className = "delete-btn";
          deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
          deleteBtn.onclick = () => showDeleteModal(item.ID, storageFolder);
          alertDiv.appendChild(deleteBtn);

          notesContainer.appendChild(alertDiv);
        });
      });
    }

    function showDeleteModal(id, folder) {
      $('#deleteModal').modal('show');
      document.getElementById('confirmDeleteBtn').onclick = () => deleteNote(id, folder);
    }

    function deleteNote(id, folder) {
      firebase.database().ref(folder + '/' + id).remove()
        .then(() => location.reload())
        .catch(err => console.error(err));
    }
  </script>
</body>
</html>
