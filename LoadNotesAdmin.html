<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Notes</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/native-toast@2.0.0/dist/native-toast.css">
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-auth.js"></script>
    <script src="https://unpkg.com/native-toast@2.0.0/dist/native-toast.min.js"></script>
    <style>
        .alert img { 
            border: 2px solid gray; 
            border-radius: 8px; 
            cursor: pointer; 
            margin-right: 10px; 
        }
        .alert { 
            display: flex; 
            align-items: center; 
            margin-bottom: 10px; 
            background-color: #f8f9fa; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); 
            border-radius: 8px; 
            padding: 10px; 
            position: relative;
        }
        .details {
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding-left: 10px;
        }
        .details span { display: block; margin-bottom: 5px; }
        .details .name { font-weight: bold; font-size: 1.2em; }
        .details .date { color: gray; font-size: 0.9em; }
        .details .separator { border-top: 1px solid #ddd; margin: 10px 0; }
        .delete-btn { position: absolute; top: 10px; right: 10px; cursor: pointer; color: red; }
        .delete-btn i { font-size: 1.5em; }
        @media (max-width: 768px) { .delete-btn i { font-size: 1.2em; } }
        @media (min-width: 769px) { .alert img { height: 80px; width: 80px; } }
        @media (max-width: 768px) { .alert img { height: 50px; width: 50px; } }
    </style>
</head>
<body onload="readData()">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <button class="btn btn-dark" onclick="window.location.href='DashboardAdmin.html'">
                <i class="fas fa-arrow-left"></i>
            </button>
            <a class="navbar-brand mx-auto" href="#">House Of Tutors</a>
        </div>
    </nav>

    <div class="container">
        <h2 class="mt-4 text-center">Uploaded Notes</h2>
        <div id="notesContainer"></div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">Are you sure you want to delete this note?</div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Yes</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        //------------------------------------------CONFIGURATIONS-----------------------
        var firebaseConfig = {
            apiKey: "AIzaSyCwol-nlbl1YbdAiU88nYFv67pJg2XOo9U",
            authDomain: "houseoftutors-f398e.firebaseapp.com",
            databaseURL: "https://houseoftutors-f398e-default-rtdb.firebaseio.com",
            projectId: "houseoftutors-f398e",
            storageBucket: "houseoftutors-f398e.appspot.com",
            messagingSenderId: "1006665226128",
            appId: "1:1006665226128:web:bcf481758d361da3ef8515",
            measurementId: "G-PEM636J9ZD"
        };
        firebase.initializeApp(firebaseConfig);

        //------------------------------------------HELPER: PICK ICON-----------------------
        function getIconByExtension(filename) {
            if (!filename) return "img/uploadnote_icons/icon-img.png";
            let ext = filename.split('.').pop().toLowerCase();
            if (["jpg","jpeg","png","gif"].includes(ext)) return "img/uploadnote_icons/icon-img.png";
            if (ext === "pdf") return "img/uploadnote_icons/icon-pdf.png";
            if (ext === "docx" || ext === "doc") return "img/uploadnote_icons/icon-docx.png";
            if (["mp4","mov","avi","mkv"].includes(ext)) return "img/uploadnote_icons/icon-video.png";
            return "img/uploadnote_icons/icon-img.png"; // fallback
        }

        //------------------------------------------LOAD DATA-----------------------
        function readData() {
            var storageFolder = localStorage.getItem('storage_folder');
            if (!storageFolder) return;

            var itemsRef = firebase.database().ref(storageFolder);
            var notesContainer = document.getElementById('notesContainer');

            itemsRef.once('value', function(snapshot) {
                var items = [];
                snapshot.forEach(snap => items.push(snap.val()));
                items.sort((a,b) => b.ID - a.ID);

                notesContainer.innerHTML = "";

                items.forEach(function(item) {
                    var alertDiv = document.createElement("div");
                    alertDiv.className = "alert";

                    // use icon instead of preview
                    var img = document.createElement("img");
                    img.src = getIconByExtension(item.Name);
                    img.onclick = function() {
                        window.open(item.Link, '_blank');
                    };
                    alertDiv.appendChild(img);

                    var detailsDiv = document.createElement("div");
                    detailsDiv.className = "details";
                    var nameSpan = document.createElement("span");
                    nameSpan.className = "name";
                    nameSpan.innerText = "File: " + item.Name;
                    detailsDiv.appendChild(nameSpan);

                    var separator = document.createElement("div");
                    separator.className = "separator";
                    detailsDiv.appendChild(separator);

                    var dateSpan = document.createElement("span");
                    dateSpan.className = "date";
                    var date = new Date(item.Time);
                    dateSpan.innerText = "Uploaded on: " + date.toLocaleString();
                    detailsDiv.appendChild(dateSpan);

                    alertDiv.appendChild(detailsDiv);

                    // delete button
                    var deleteBtn = document.createElement("span");
                    deleteBtn.className = "delete-btn";
                    deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                    deleteBtn.onclick = () => showDeleteModal(item.ID, storageFolder);
                    alertDiv.appendChild(deleteBtn);

                    notesContainer.appendChild(alertDiv);
                });
            });
        }

        //------------------------------------------DELETE-----------------------
        function showDeleteModal(image_id, storageFolder) {
            $('#deleteModal').modal('show');
            document.getElementById('confirmDeleteBtn').onclick = function() {
                deleteNote(image_id, storageFolder);
            };
        }
        function deleteNote(image_id, storageFolder) {
            firebase.database().ref(storageFolder + '/' + image_id).remove()
                .then(function() {
                    location.reload();
                }).catch(function(error) {
                    console.error('Error deleting note from database:', error);
                });
        }
    </script>
</body>
</html>
