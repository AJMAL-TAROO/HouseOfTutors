<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Save and load image from firebase</title>

        <style>
            img{height:540px; width:320px; border:2px solid black;}

            .paymentlogo{
				width:30px; height:30px;
			}
			
			.productImg{
				width:480px; 
				height:320px;
				background-image: url('images/r1b2.jpg');
				background-position:center;
				background-repeat:no-repeat;
				background-size:cover;
			}

            .editText{height:10; font-size:16pt; width:200; border: 2px solid black; border-radius:10px; padding:20px; text-align:center}

            table {
                border: 0px solid #CCC;
                border-collapse: collapse;
            }

            td {
                border: none;
                padding: 0;
            }
            
        </style>

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
        <link rel="stylesheet" type="text/css" href="css/style.css">
        <script type="text/javascript" src="https://code.jquery.com/jquery-latest.min.js"></script>
        <!--toast... -->
        <link rel="stylesheet" href="https://unpkg.com/native-toast@2.0.0/dist/native-toast.css">
        <script src="https://unpkg.com/native-toast@2.0.0/dist/native-toast.min.js"></script>


        <!---------------------------------------FIREBASE LIBRARIES---------------------------------------------------->
        <script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-database.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-storage.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-auth.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>

    </head>

    <body onload = "readData()">
        
        <center>
            <br>
                <img id="myimg"> <label id="upProgress"></label>
            </br>
            <br>
                <button id="select">Select Image</button>
                <button id="upload">Send</button>
            </br>
        </center>

        <script id="MainScript">

          //------------------------------------------VARIABLES---------------------------
            var ImgName, ImgUrl;
            var files = [];
            var reader;
            
            var id_number;

         //------------------------------------------CONFIGURATIONS-----------------------
            var firebaseConfig = {
                apiKey: "AIzaSyCwol-nlbl1YbdAiU88nYFv67pJg2XOo9U",
                authDomain: "houseoftutors-f398e.firebaseapp.com",
                databaseURL: "https://houseoftutors-f398e-default-rtdb.firebaseio.com",
                projectId: "houseoftutors-f398e",
                storageBucket: "houseoftutors-f398e.firebasestorage.app",
                messagingSenderId: "1006665226128",
                appId: "1:1006665226128:web:bcf481758d361da3ef8515",
                measurementId: "G-PEM636J9ZD"
            };

            // Initialize Firebase...
            firebase.initializeApp(firebaseConfig);

        //------------------------------------------SELECTION PROCESS-----------------------
            document.getElementById("select").onclick = function(e){

                var input = document.createElement('input');
                input.type = 'file';

                input.onchange = e =>{
                    files = e.target.files;
                    reader = new FileReader();
                    reader.onload = function(){
                        document.getElementById("myimg").src = reader.result;
                    }
                    reader.readAsDataURL(files[0]);
                }
                input.click();
            }

        //------------------------------------------UPLOAD PROCESS-----------------------
            document.getElementById('upload').onclick = function(){
                
                var uploadTask = firebase.storage().ref('1001_NOTES/' + id_number + ".png").put(files[0]);

                uploadTask.on('state_changed', function(snapshot){
                    var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    document.getElementById('upProgress').innerHTML = 'Upload - ' + progress + '%';
                },
                
                function(error){
                    alert('error in saving the image');
                },

                function(){
                    uploadTask.snapshot.ref.getDownloadURL().then(function(url){
                        ImgUrl = url;
                    
                        firebase.database().ref('1001_NOTES/'+ id_number).set({
                            ID: id_number,
                            Link: ImgUrl,
                            Time: Date.now()
                        });

                        firebase.database().ref('NUMBERS/ID_NUMBER').set({
                            NUMBER: id_number
                        });
            
                        nativeToast({
                            message: 'Note was uploaded successfully!',
                            position: 'center',    
                            rounded: true,
                            timeout: 10000,
                            type: '',
                            icon: false,
                            edge:true,
                            closeOnClick: false,
                            elements: [createElement()]
                        });

                        document.getElementById('myimg').src = '//:0'

                        }
                    );
                });
            }
                        
            //------------------------------------------LOAD id_number FROM FIREBASE REALTIME DATABASE-----------------------
            function readData() {

                // #RETRIEVE ONLY EMAIL AS VALUE...
                firebase.database().ref('NUMBERS/ID_NUMBER/NUMBER').on('value',(snap)=>{

                    id_number = snap.val();
                    id_number = id_number + 1

                    // nativeToast({
                    //     message: id_number,
                    //     position: 'center',    
                    //     rounded: true,
                    //     timeout: 10000,
                    //     type: '',
                    //     icon: false,
                    //     edge:true,
                    //     closeOnClick: false,
                    //     elements: [createElement()]
                    // });
                }); 
            }

            //------------------------------------------HELPS TO CREATE POPUP-----------------------
            function createElement(){
                let el = document.createElement('div');
                let child = document.createElement('p');
                el.appendChild(child);
                return el;
            }

        </script>

    </body>

</html>