<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.22/dist/full.min.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://unpkg.com/native-toast@2.0.0/dist/native-toast.css">
    <script src="https://unpkg.com/native-toast@2.0.0/dist/native-toast.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <title>Time Table</title>
    <style>
        html, body {
            height: 100%;
        }
        body {
            background: white;
        }
        .container.centered-content {
            background: #fff;
            border-radius: 0.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            padding: 2rem;
            margin-top: 2rem;
        }
        table.equal-cols {
            table-layout: fixed;
            width: 100%;
        }
        table.equal-cols th, table.equal-cols td {
            width: 33.33%;
            word-break: break-word;
        }
        /* Use same color as navbar for table header */
        .table-header-bg {
            background-color: #343a40 !important;
            color: #fff !important;
        }
    </style>
</head>

<body class="bg-gray-100">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <button class="btn btn-dark" onclick="window.location.href='DashboardAdmin.html'">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            <a class="navbar-brand mx-auto" href="#">House Of Tutors</a>
        </div>
    </nav>

    <div class="container centered-content">
        <div class="container mx-auto">
            <h2 class="text-2xl font-bold mt-8 mb-4 text-center">Time Table Overview</h2>
            <div id="timeTableOverview" class="bg-white rounded-lg p-4">
                <!-- Time table overview will be populated dynamically -->
            </div>
            <div class="flex justify-center space-x-4 mt-8">
                <button class="btn btn-primary" onclick="window.location.href='AddSessionForTimetable.html'">Add Session</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getDatabase, ref, onValue, get, set } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCwol-nlbl1YbdAiU88nYFv67pJg2XOo9U",
            authDomain: "houseoftutors-f398e.firebaseapp.com",
            databaseURL: "https://houseoftutors-f398e-default-rtdb.firebaseio.com/",
            projectId: "houseoftutors-f398e",
            storageBucket: "houseoftutors-f398e.appspot.com",
            messagingSenderId: "1006665226128",
            appId: "1:1006665226128:web:bcf481758d361da3ef8515",
            measurementId: "G-PEM636J9ZD"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        const dayMap = {
            1: 'Monday',
            2: 'Tuesday',
            3: 'Wednesday',
            4: 'Thursday',
            5: 'Friday',
            6: 'Saturday',
            7: 'Sunday'
        };

        async function getAdminKey(database, adminEmail) {
            const adminRef = ref(database, "ADMIN");
            const adminSnapshot = await get(adminRef);
            if (adminSnapshot.exists()) {
                const admins = adminSnapshot.val();
                for (const key in admins) {
                    if (admins[key].EMAIL === adminEmail) {
                        return key;
                    }
                }
            }
            return null;
        }

        async function updateTimeTableOverview() {
            const timeTableOverview = document.getElementById('timeTableOverview');
            timeTableOverview.innerHTML = '';
            const adminEmail = localStorage.getItem('userEmail');
            const adminKey = await getAdminKey(database, adminEmail);
            if (!adminKey) return;

            const timeTableRef = ref(database, `TIME_TABLE/${adminKey}/VALUE`);
            onValue(timeTableRef, (snapshot) => {
                const timeTable = snapshot.val();
                if (!timeTable) return;
                for (const day in timeTable) {
                    if (timeTable.hasOwnProperty(day)) {
                        const daySection = document.createElement('div');
                        daySection.classList.add('mb-4');
                        const dayTitle = document.createElement('h3');
                        dayTitle.classList.add('text-xl', 'font-bold', 'mb-2');
                        dayTitle.textContent = dayMap[day];
                        daySection.appendChild(dayTitle);

                        const table = document.createElement('table');
                        table.classList.add('equal-cols', 'table-auto', 'w-full', 'text-center');
                        const thead = document.createElement('thead');
                        thead.innerHTML = `
                            <tr class="table-header-bg">
                                <th class="px-4 py-2">Time</th>
                                <th class="px-4 py-2">Classroom</th>
                                <th class="px-4 py-2">Action</th>
                            </tr>
                        `;
                        table.appendChild(thead);

                        const tbody = document.createElement('tbody');
                        for (const time in timeTable[day]) {
                            if (timeTable[day].hasOwnProperty(time)) {
                                const classroom = timeTable[day][time];
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td class="border px-4 py-2">${time}</td>
                                    <td class="border px-4 py-2">${classroom}</td>
                                    <td class="border px-4 py-2">
                                        <button class="btn btn-danger btn-sm" onclick="deleteSession('${day}', '${time}')">Delete</button>
                                    </td>
                                `;
                                tbody.appendChild(row);
                            }
                        }
                        table.appendChild(tbody);
                        daySection.appendChild(table);
                        timeTableOverview.appendChild(daySection);
                    }
                }
            });
        }

        window.deleteSession = async function(day, time) {
            const adminEmail = localStorage.getItem('userEmail');
            const adminKey = await getAdminKey(database, adminEmail);
            if (!adminKey) return;
            const sessionRef = ref(database, `TIME_TABLE/${adminKey}/VALUE/${day}/${time}`);
            await set(sessionRef, null);
            nativeToast({
                message: 'Time table updated successfully!',
                position: 'center',
                rounded: true,
                timeout: 5000,
                type: 'success',
                icon: false,
                edge: true,
                closeOnClick: false
            });
            setTimeout(() => {
                location.reload();
            }, 1500);
        };

        updateTimeTableOverview();
    </script>
</body>
</html>