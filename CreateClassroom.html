<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO Meta Tags -->
    <title>Create Classroom - House of Tutors | Admin Panel</title>
    <meta name="description" content="Create and manage classrooms at House of Tutors admin panel.">
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://www.housesoftutors.com/CreateClassroom.html">    
    <!-- Favicon and Site Icons -->
    <link rel="icon" type="image/png" href="img/houseoftutor_logo.png">
    <link rel="apple-touch-icon" href="img/houseoftutor_logo.png">

    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.22/dist/full.min.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://unpkg.com/native-toast@2.0.0/dist/native-toast.css">
    <script src="https://unpkg.com/native-toast@2.0.0/dist/native-toast.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        html, body {
            height: 100%;
        }
        body {
            background: white;
        }
        .container.centered-content {
            background: #fff;
            border-radius: 0.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            padding: 2rem;
            margin-top: 2rem;
        }
    </style>
</head>

<body class="bg-gray-100" style="padding: 10px;">

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <button class="btn btn-dark" onclick="window.location.href='DashboardAdmin.html'">
                <i class="fas fa-arrow-left"></i>
            </button>
            <a class="navbar-brand mx-auto" href="#">House Of Tutors</a>
        </div>
    </nav>

    <div class="container centered-content">
        <div class="container mx-auto">
            <h2 class="text-2xl mb-4 text-center">Create New Classroom</h2>
            <form id="addClassroomForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="title">Title</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-white" id="title" type="text" placeholder="Title">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="teacherFullName">Teacher Full Name</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-white" id="teacherFullName" type="text" placeholder="Teacher Full Name">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="teacherAddress">Teacher Address</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-white" id="teacherAddress" type="text" placeholder="Teacher Address">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="teacherTel">Teacher Telephone</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-white" id="teacherTel" type="text" placeholder="Teacher Telephone">
                </div>
                <div class="flex items-center justify-between">
                    <button class="btn btn-primary" type="button" onclick="uploadClassroomData()">Upload</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCwol-nlbl1YbdAiU88nYFv67pJg2XOo9U",
            authDomain: "houseoftutors-f398e.firebaseapp.com",
            databaseURL: "https://houseoftutors-f398e-default-rtdb.firebaseio.com/",
            projectId: "houseoftutors-f398e",
            storageBucket: "houseoftutors-f398e.appspot.com",
            messagingSenderId: "1006665226128",
            appId: "1:1006665226128:web:bcf481758d361da3ef8515",
            measurementId: "G-PEM636J9ZD"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        let classroomId;
        let adminVrLink = null;

        // On page load, fetch classroom ID and admin VR_LINK
        window.onload = async function() {
            try {
                // Get classroom ID
                const classroomIdRef = ref(database, "NUMBERS/CURRENT_ID_CLASSROOM/NUMBER");
                const snapshot = await get(classroomIdRef);
                if (snapshot.exists()) {
                    classroomId = snapshot.val() + 1;
                }

                // Get admin VR_LINK based on email
                const email = localStorage.getItem('userEmail');
                if (email) {
                    const adminRef = ref(database, "ADMIN");
                    const adminSnapshot = await get(adminRef);
                    if (adminSnapshot.exists()) {
                        const admins = adminSnapshot.val();
                        for (const key in admins) {
                            if (admins[key].EMAIL === email) {
                                adminVrLink = admins[key].VR_LINK;
                                break;
                            }
                        }
                    }
                }
            } catch (error) {
                console.error("Error on page load:", error);
            }
        };

        // Upload classroom data
        window.uploadClassroomData = async function() {
            const title = document.getElementById('title').value;
            const teacherFullName = document.getElementById('teacherFullName').value;
            const teacherAddress = document.getElementById('teacherAddress').value;
            const teacherTel = document.getElementById('teacherTel').value;

            if (!title || !teacherFullName || !teacherAddress || !teacherTel) {
                nativeToast({
                    message: 'All fields must be filled!',
                    position: 'center',
                    rounded: true,
                    timeout: 2000,
                    type: 'error'
                });
                return;
            }

            // Always use admin's VR_LINK
            const classroomData = {
                CLASSROOM_ID: classroomId,
                STORAGE_FOLDER: `${classroomId}_NOTES`,
                TEACHER_ADDRESS: teacherAddress,
                TEACHER_FULL_NAME: teacherFullName,
                TEACHER_TEL: teacherTel,
                TITLE: title,
                VR_LINK: adminVrLink
            };

            try {
                // Save classroom
                await set(ref(database, `CLASSROOMS/CLASSROOM_${classroomId}`), classroomData);

                // Update numbers
                await set(ref(database, "NUMBERS/CURRENT_ID_CLASSROOM/NUMBER"), classroomId);
                await set(ref(database, `NUMBERS/ID_CLASSROOM_${classroomId}_NOTES/NUMBER`), 1);

                // Add classroom to admin's VIRTUAL_ROOMS list and log the action
                const email = localStorage.getItem('userEmail');
                if (email) {
                    const adminRef = ref(database, "ADMIN");
                    const adminSnapshot = await get(adminRef);
                    if (adminSnapshot.exists()) {
                        const admins = adminSnapshot.val();
                        for (const key in admins) {
                            if (admins[key].EMAIL === email) {
                                const virtualRooms = admins[key].VIRTUAL_ROOMS ? admins[key].VIRTUAL_ROOMS.split(',') : [];
                                virtualRooms.push(classroomId.toString());
                                await update(ref(database, `ADMIN/${key}`), { VIRTUAL_ROOMS: virtualRooms.join(',') });
                                
                                // Log the successful classroom creation
                                const logData = {
                                    CLASSROOM_ID: classroomId,
                                    CLASSROOM_TITLE: title,
                                    TIMESTAMP: Date.now(),
                                    DATE: new Date().toISOString()
                                };
                                await set(ref(database, `ADMIN/${key}/LOGS/LAST_CREATED_CLASSROOM`), logData);
                                break;
                            }
                        }
                    }
                }

                nativeToast({
                    message: 'Classroom created successfully!',
                    position: 'center',
                    rounded: true,
                    timeout: 2000,
                    type: 'success'
                });

                setTimeout(() => location.reload(), 2000);

            } catch (error) {
                console.error("Error uploading classroom data:", error);
            }
        };
    </script>

</body>
</html>
